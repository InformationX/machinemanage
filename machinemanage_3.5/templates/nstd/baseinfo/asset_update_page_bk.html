{% extends 'base.html' %}
{% load staticfiles %}
{% block content %}

<fieldset class="layui-elem-field layui-field-title atitle">
  <legend>资产信息修改</legend>
</fieldset>

<div class="layui-form mart10" style="min-width: 1025px">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">资产番号:</label>
      <div class="layui-input-inline">
        <input type="hidden" id="a_material_id"/>
        <input type="hidden" id="a_action_id"/>
        <input id="a_cd" class="layui-input" autocomplete="off" placeholder="请输入资产番号" 
          onkeyup="get_asset_detail()">
      </div>
      <div class="xing">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">资产型号:</label>
      <div class="layui-input-inline">
        <input id="a_type_cd" class="layui-input" autocomplete="off">
      </div>
      <div class="xing v-hid">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">资产名称:</label>
      <div class="layui-input-inline">
        <input id="a_name" class="layui-input" autocomplete="off">
      </div>
      <div class="xing v-hid">*</div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">资产编号:</label>
      <div class="layui-input-inline">
        <input id="a_self_cd" class="layui-input" autocomplete="off">
      </div>
      <div class="xing v-hid">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">机身号码:</label>
      <div class="layui-input-inline">
        <input id="a_fuselage_cd" class="layui-input" autocomplete="off">
      </div>
      <div class="xing v-hid">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">工程代码:</label>
      <div class="layui-input-inline">
        <input id="a_project_cd" class="layui-input" autocomplete="off">
      </div>
      <div class="xing v-hid">*</div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">折旧分类:</label>
      <div class="fl h36_w190">
        <select id="a_action_category" lay-filter="change_category">
          <option value="">请选择资产折旧分类</option>
          <option>A</option>
          <option>B</option>
          <option>C</option>
          <option>D</option>
          <option>E</option>
        </select>
      </div>
      <div class="xing marl10 v-hid">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">当前部门:</label>
      <div class="layui-input-inline">
        <input id="a_action_depart" class="layui-input" autocomplete="off" placeholder="请输入当前部门">
      </div>
      <div class="xing">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">库存状态:</label>
      <div class="layui-input-inline">
        <input id="a_action_type" class="layui-input" readonly 
        	style="background:gray;color:#fff;font-weight:bold">
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">资产状态:</label>
      <div class="fl h36_w190">
        <select id="a_action_state" lay-filter="change_state">
          <option value=''>请选择资产状态</option>
          <option>A</option>
          <option>B</option>
          <option>C</option>
          <option>D</option>
          <option>E</option>
          <option>F</option>
          <option>G</option>
          <option>H</option>
          <option>I</option>
          <option>J</option>
          <option>K</option>
        </select>
      </div>
      <div class="xing marl10">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">资产位置:</label>
      <div class="layui-input-inline">
        <input id="a_action_loc" class="layui-input" placeholder="请输入资产位置" autocomplete="off">
      </div>
      <div class="xing">*</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">备注信息:</label>
      <div class="layui-input-inline">
        <input id="a_action_remark" class="layui-input" placeholder="请输入备注信息" autocomplete="off">
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">PO号:</label>
      <div class="layui-input-inline">
        <input id="a_po_cd" class="layui-input" placeholder="请输入PO号" autocomplete="off">
      </div>
      <div class="xing">&nbsp;</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">请示书号:</label>
      <div class="layui-input-inline">
        <input id="a_referendum" class="layui-input" placeholder="请输入请示书号" autocomplete="off">
      </div>
      <div class="xing">&nbsp;</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">经费类别:</label>
      <div class="layui-input-inline">
        <input id="a_funds_type" class="layui-input" placeholder="请输入经费类别" autocomplete="off">
      </div>
      <div class="xing">&nbsp;</div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">购入机种:</label>
      <div class="layui-input-inline">
        <input id="a_model" class="layui-input" placeholder="请输入购入机种" autocomplete="off">
      </div>
      <div class="xing">&nbsp;</div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">供应商:</label>
      <div class="layui-input-inline">
        <input id="a_supplier" class="layui-input" placeholder="请输入资产位置" autocomplete="off">
      </div>
      <div class="xing">&nbsp;</div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label"></label>
      <button class="layui-btn" onclick="asset_update()">
        <i class="layui-icon">&#xe642;</i>确定修改
      </button>
    </div>
    <div class="layui-inline">
      <button type="reset" class="layui-btn layui-btn-primary" onclick="reset()">
        <i class="layui-icon">&#xe9aa;</i>重置输入
      </button>
    </div>
  </div>

  <div style="padding: 20px; background-color: #F2F2F2;">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md6">
        <div class="layui-card">
          <div class="layui-card-header">修改当前部门、资产位置、使用机种、备注</div>
          <div class="layui-card-body">
            <div style="margin:15px 0">
              <div class="layui-inline" style="margin-left: 160px">
                <a class="layui-btn" href="/nstd/basefunc/download_template?param=asset_modify_1"> 
                  <i class="layui-icon">&#xe601;</i>模板下载
                </a>
              </div>
              <div class="layui-inline">
                <button class="layui-btn" id="upload_modify_1">
                  <i class="layui-icon">&#xe67c;</i>上传数据
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="layui-col-md6" style="visibility: hidden">
        <div class="layui-card">
          <div class="layui-card-header">资产冲销（按资产号删除资产）。</div>
          <div class="layui-card-body">
            <div style="margin:15px 0">
              <div class="layui-inline" style="margin-left: 160px">
                <a class="layui-btn" href="/nstd/basefunc/download_template?param=asset_modify_2">
                  <i class="layui-icon">&#xe601;</i>模板下载
                </a>
              </div>
              <div class="layui-inline">
                <button class="layui-btn" id="upload_modify_2">
                  <i class="layui-icon">&#xe67c;</i>上传数据
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="layui-col-md6">
        <div class="layui-card">
          <div class="layui-card-header">修改资产单价、币种。</div>
          <div class="layui-card-body">
            <div style="margin:15px 0">
              <div class="layui-inline" style="margin-left: 160px">
                <a class="layui-btn" href="/nstd/basefunc/download_template?param=asset_modify_3">
                  <i class="layui-icon">&#xe601;</i>模板下载
                </a>
              </div>
              <div class="layui-inline">
                <button class="layui-btn" id="upload_modify_3">
                  <i class="layui-icon">&#xe67c;</i>上传数据
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="layui-col-md6">
        <div class="layui-card">
          <div class="layui-card-header">修改资产状态、折旧类别。</div>
          <div class="layui-card-body">
            <div style="margin:15px 0">
              <div class="layui-inline" style="margin-left: 160px">
                <a class="layui-btn" href="/nstd/basefunc/download_template?param=asset_modify_4"> 
                  <i class="layui-icon">&#xe601;</i>模板下载
                </a>
              </div>
              <div class="layui-inline">
                <button class="layui-btn" id="upload_modify_4">
                  <i class="layui-icon">&#xe67c;</i>上传数据
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  var layer = ''
  var $ = ''
  var form = ''
  var upload = ''
  layui.use(['layer', 'jquery', 'form', 'upload'], function(){
    $ = layui.jquery
  	layer = layui.layer
    form = layui.form
    upload = layui.upload

    //修改当前部门、资产位置、使用机种、备注。
    uploadInst = upload.render({
      elem: '#upload_modify_1',
      url: '/nstd/basefunc/upload_file',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      accept: 'file',
      before: function(obj){
        layer.load();
      },
      done: function(res){
        layer.closeAll('loading');
        let result = res.result
        if(result){ //文件上传成功
          let tmp_file = res.tmp_file;  
          //弹出即全屏
          var index = layer.open({
            type: 2,
            title: '资产设备批量修改',
            content: '/nstd/basefunc/upload_table_page?flag=upload_modify_1&tmp_file=' + tmp_file,
            area: ['320px', '195px'],
            maxmin: true
          });
          layer.full(index);
        }
      },
      error:function(){
        layer.closeAll('loading');
      }
    });

    //资产批量冲消。
    uploadInst = upload.render({
      elem: '#upload_modify_2',
      url: '/nstd/basefunc/upload_file',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      accept: 'file',
      before: function(obj){
        layer.load();
      },
      done: function(res){
        layer.closeAll('loading');
        let result = res.result
        if(result){ //文件上传成功
          let tmp_file = res.tmp_file;  
          //弹出即全屏
          var index = layer.open({
            type: 2,
            title: '资产设备批量修改',
            content: '/nstd/basefunc/upload_table_page?flag=upload_modify_2&tmp_file=' + tmp_file,
            area: ['320px', '195px'],
            maxmin: true
          });
          layer.full(index);
        }
      },
      error:function(){
        layer.closeAll('loading');
      }
    });

    //价格、币种批量修改
    uploadInst = upload.render({
      elem: '#upload_modify_3',
      url: '/nstd/basefunc/upload_file',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      accept: 'file',
      before: function(obj){
        layer.load();
      },
      done: function(res){
        layer.closeAll('loading');
        let result = res.result
        if(result){ //文件上传成功
          let tmp_file = res.tmp_file;  
          //弹出即全屏
          var index = layer.open({
            type: 2,
            title: '资产设备批量修改',
            content: '/nstd/basefunc/upload_table_page?flag=upload_modify_3&tmp_file=' + tmp_file,
            area: ['320px', '195px'],
            maxmin: true
          });
          layer.full(index);
        }
      },
      error:function(){
        layer.closeAll('loading');
      }
    });

    //资产状态、折旧类别
    uploadInst = upload.render({
      elem: '#upload_modify_4',
      url: '/nstd/basefunc/upload_file',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      accept: 'file',
      before: function(obj){
        layer.load();
      },
      done: function(res){
        layer.closeAll('loading');
        let result = res.result
        if(result){ //文件上传成功
          let tmp_file = res.tmp_file;  
          //弹出即全屏
          var index = layer.open({
            type: 2,
            title: '资产设备批量修改',
            content: '/nstd/basefunc/upload_table_page?flag=upload_modify_4&tmp_file=' + tmp_file,
            area: ['320px', '195px'],
            maxmin: true
          });
          layer.full(index);
        }
      },
      error:function(){
        layer.closeAll('loading');
      }
    });

  });

  //更新资产前查询
  function get_asset_detail(){ 
    let keyCode = window.event.keyCode
    if(keyCode == 13){
      let a_cd = $('#a_cd').val()
      if(a_cd == ''){
        layer.alert('资产番号不能为空！',{title:'温馨提示',icon:7})
      }else{
        $.ajax({
          url: '/nstd/baseinfo/get_asset_detail',
          type: 'get',
          dataType: 'json',
          data: {a_cd:a_cd},
          success:function(data){
            if(data.result){
            	$('#a_material_id').val(data.a_material_id)
            	$('#a_action_id').val(data.a_action_id)
            	$('#a_type_cd').val(data.a_type_cd)
              $('#a_name').val(data.a_name)
              $('#a_self_cd').val(data.a_self_cd)
              $('#a_fuselage_cd').val(data.a_fuselage_cd)
              $('#a_project_cd').val(data.a_project_cd)
              $('#a_action_category').val(data.a_action_category)
              $('#a_action_type').val(data.a_action_type)
              $('#a_action_state').val(data.a_action_state)
              $('#a_action_loc').val(data.a_action_loc)
              $('#a_po_cd').val(data.a_po_cd)
              $('#a_referendum').val(data.a_referendum)
              $('#a_funds_type').val(data.a_funds_type)
              $('#a_model').val(data.a_model)
              $('#a_supplier').val(data.a_supplier)
              $('#a_action_depart').val(data.a_action_depart)
              $('#a_action_remark').val(data.a_action_remark)
              $('#a_cd').attr('readonly','')
              form.render('select')
            }else{
              	layer.alert(data.msg,{title:'温馨提示',icon:7})
            }
          }
        })
      }
    }
  }

  //更改数据
  function asset_update(){
    let a_material_id = $('#a_material_id').val()
    let a_action_id = $('#a_action_id').val()
    let a_type_cd = $('#a_type_cd').val()
    let a_name = $('#a_name').val()
    let a_self_cd = $('#a_self_cd').val()
    let a_fuselage_cd = $('#a_fuselage_cd').val()
    let a_project_cd = $('#a_project_cd').val()
    let a_action_category = $('#a_action_category').val()
    let a_action_state = $('#a_action_state').val()
    let a_action_loc = $('#a_action_loc').val()
    let a_po_cd = $('#a_po_cd').val()
    let a_referendum = $('#a_referendum').val()
    let a_funds_type = $('#a_funds_type').val()
    let a_model = $('#a_model').val()
    let a_supplier = $('#a_supplier').val()
    let a_action_depart = $('#a_action_depart').val()
    let a_action_remark = $('#a_action_remark').val()
    if(a_cd == ''){
      layer.alert('资产番号不能为空！',{title:'温馨提示',icon:7})
      return
    }else if(a_material_id == ''){
      layer.alert('未搜索数据到数据!',{title:'温馨提示',icon:7})
      return
    }
    let data = {
      a_material_id:a_material_id,a_action_id:a_action_id,a_type_cd:a_type_cd,
      a_name:a_name,a_self_cd:a_self_cd,a_fuselage_cd:a_fuselage_cd,a_project_cd:a_project_cd,
      a_action_category:a_action_category,a_action_state:a_action_state,a_action_loc:a_action_loc,
      a_po_cd:a_po_cd,a_referendum:a_referendum,a_funds_type:a_funds_type,a_model:a_model,
      a_supplier:a_supplier,a_action_depart:a_action_depart,a_action_remark:a_action_remark
    }
    data['csrfmiddlewaretoken'] = $('input[name="csrfmiddlewaretoken"]').val()
    $.ajax({
      url: '/nstd/baseinfo/asset_update',
      type: 'post',
      data: data,
      dataType: 'json',
      success:function(data){
        if(data.result){
          layer.msg('操作成功',{icon:1})
          reset()
        }else{
          layer.alert('操作失败',{title:'温馨提示',icon:2})
        }
      }
    })
  }

  function reset(){
  	$('input[name!="csrfmiddlewaretoken"]').val('')
  	$('#a_cd').removeAttr('readonly').focus()
  }

</script>
{% endblock %}